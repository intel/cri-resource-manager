

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Setup and Usage &mdash; CRI Resource Manager 0.4.0-151-g921c790 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Policies" href="policy/index.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> CRI Resource Manager
          

          
          </a>

          
            
            
              <div class="version">
                devel
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick-start.html">Quick-start</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Setup and Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-kubelet-to-use-cri-resource-manager-as-the-runtime">Setting Up kubelet To Use CRI Resource Manager as the Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-cri-resource-manager">Setting Up CRI Resource Manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-a-local-configuration-from-a-file">Using a Local Configuration From a File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-cri-resource-manager-agent-and-a-configmap">Using CRI Resource Manager Agent and a ConfigMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changing-the-active-policy">Changing the Active Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#container-adjustments">Container Adjustments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#commands-for-declaring-creating-deleting-and-examining-adjustments">Commands for Declaring, Creating, Deleting, and Examining Adjustments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-cri-resource-manager-as-a-message-dumper">Using CRI Resource Manager as a Message Dumper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-docker-as-the-runtime">Using Docker as the Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging-and-debugging">Logging and Debugging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-agent.html">Node Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="webhook.html">Webhook</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers-guide/index.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="demos/index.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Reporting a Potential Security Vulnerability</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/cri-resource-manager">Project GitHub repository</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CRI Resource Manager</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Setup and Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/docs/setup.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="setup-and-usage">
<h1>Setup and Usage<a class="headerlink" href="#setup-and-usage" title="Permalink to this headline">¶</a></h1>
<p>If you want to give CRI Resource Manager a try, here is the list of things
you need to do, assuming you already have a Kubernetes cluster up and running,
using either <code class="docutils literal notranslate"><span class="pre">containerd</span></code> or <code class="docutils literal notranslate"><span class="pre">cri-o</span></code> as the runtime.</p>
<ol class="simple">
<li><p><a class="reference internal" href="installation.html"><span class="doc">Install</span></a> CRI Resource Manager.</p></li>
<li><p>Set up kubelet to use CRI Resource Manager as the runtime.</p></li>
<li><p>Set up CRI Resource Manager to use the runtime with a policy.</p></li>
</ol>
<p>For kubelet you do this by altering its command line options like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">kubelet</span> <span class="o">&lt;</span><span class="n">other</span><span class="o">-</span><span class="n">kubelet</span><span class="o">-</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="n">remote</span> \
     <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">endpoint</span><span class="o">=</span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
<p>For CRI Resource Manager, you need to provide a configuration file, and also a
socket path if you don’t use <code class="docutils literal notranslate"><span class="pre">containerd</span></code> or you run it with a different socket
path.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="c1"># for containerd with default socket path</span>
   <span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">config</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">runtime</span><span class="o">-</span><span class="n">socket</span> <span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">containerd</span><span class="o">/</span><span class="n">containerd</span><span class="o">.</span><span class="n">sock</span>
   <span class="c1"># for cri-o</span>
   <span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">config</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">runtime</span><span class="o">-</span><span class="n">socket</span> <span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">crio</span><span class="o">/</span><span class="n">crio</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
<p>The choice of policy to use along with any potential parameters specific to that
policy are taken from the configuration file. You can take a look at the
<a class="reference external" href="https://github.com/intel/cri-resource-manager/tree/921c790d6fdac82adbcb5db1046fc8d05ccaad0b/sample-configs">sample configurations</a> for some minimal/trivial examples. For instance,
you can use <a class="reference external" href="https://github.com/intel/cri-resource-manager/blob/921c790d6fdac82adbcb5db1046fc8d05ccaad0b/sample-configs/memtier-policy.cfg">sample-configs/memtier-policy.cfg</a>
as <code class="docutils literal notranslate"><span class="pre">&lt;config-file&gt;</span></code> to activate the topology aware policy with memory tiering support.</p>
<p><strong>NOTE</strong>: Currently the available policies are work in progress.</p>
<div class="section" id="setting-up-kubelet-to-use-cri-resource-manager-as-the-runtime">
<h2>Setting Up kubelet To Use CRI Resource Manager as the Runtime<a class="headerlink" href="#setting-up-kubelet-to-use-cri-resource-manager-as-the-runtime" title="Permalink to this headline">¶</a></h2>
<p>To let CRI Resource Manager act as a proxy between kubelet and the CRI runtime
you need to configure kubelet to connect to CRI Resource Manager instead of
the runtime. You do this by passing extra command line options to kubelet like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">kubelet</span> <span class="o">&lt;</span><span class="n">other</span><span class="o">-</span><span class="n">kubelet</span><span class="o">-</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="n">remote</span> \
     <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">endpoint</span><span class="o">=</span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-cri-resource-manager">
<h2>Setting Up CRI Resource Manager<a class="headerlink" href="#setting-up-cri-resource-manager" title="Permalink to this headline">¶</a></h2>
<p>Setting up CRI Resource Manager involves pointing it to your runtime and
providing it with a configuration. Pointing to the runtime is done using
the <code class="docutils literal notranslate"><span class="pre">--runtime-socket</span> <span class="pre">&lt;path&gt;</span></code> and, optionally, the <code class="docutils literal notranslate"><span class="pre">--image-socket</span> <span class="pre">&lt;path&gt;</span></code>.</p>
<p>For providing a configuration there are two options:</p>
<ol class="simple">
<li><p>use a local configuration YAML file</p></li>
<li><p>use the <a class="reference internal" href="node-agent.html"><span class="doc">CRI Resource Manager Node Agent</span></a> and a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code></p></li>
</ol>
<p>The former is easier to set up and it is also the preferred way to run CRI
Resource Manager for development, and in some cases testing. Setting up the
latter is a bit more involved but it allows you to</p>
<ul class="simple">
<li><p>manage policy configuration for your cluster as a single source, and</p></li>
<li><p>dynamically update that configuration</p></li>
</ul>
<div class="section" id="using-a-local-configuration-from-a-file">
<h3>Using a Local Configuration From a File<a class="headerlink" href="#using-a-local-configuration-from-a-file" title="Permalink to this headline">¶</a></h3>
<p>This is the easiest way to run CRI Resource Manager for development or testing.
You can do it with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">config</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">-</span><span class="n">file</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">runtime</span><span class="o">-</span><span class="n">socket</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>When started this way CRI Resource Manager reads its configuration from the
given file. It does not fetch external configuration from the node agent and
also disables the config interface for receiving configuration updates.</p>
</div>
<div class="section" id="using-cri-resource-manager-agent-and-a-configmap">
<h3>Using CRI Resource Manager Agent and a ConfigMap<a class="headerlink" href="#using-cri-resource-manager-agent-and-a-configmap" title="Permalink to this headline">¶</a></h3>
<p>This setup requires an extra component, the <a class="reference internal" href="node-agent.html"><span class="doc">CRI Resource Manager Node Agent</span></a>,
to monitor and fetch configuration from the ConfigMap and pass it on to CRI
Resource Manager. By default CRI Resource Manager will automatically try to
use the agent to acquire configuration, unless you override this by forcing
a static local configuration using the <code class="docutils literal notranslate"><span class="pre">--force-config</span> <span class="pre">&lt;config-file&gt;</span></code> option.
When using the agent, it is also possible to provide an initial fallback for
configuration using the <code class="docutils literal notranslate"><span class="pre">--fallback-config</span> <span class="pre">&lt;config-file&gt;</span></code>. This file will be
use before the very first configuration is successfully acquired from the
agent.</p>
<p>Whenever a new configuration is acquired from the agent and successfully
taken into use, this configuration is stored in the cache and will become
the default configuration to take into use the next time CRI Resource
Manager is restarted (unless that time the –force-config option is used).
While CRI Resource Manager is shut down, any cached configuration can be
cleared from the cache using the –reset-config command line option.</p>
<p>See the <a class="reference internal" href="node-agent.html"><span class="doc">Node Agent</span></a> about how to set up and configure the agent.</p>
</div>
<div class="section" id="changing-the-active-policy">
<h3>Changing the Active Policy<a class="headerlink" href="#changing-the-active-policy" title="Permalink to this headline">¶</a></h3>
<p>Currently CRI Resource Manager will disable changing the active policy using
the <a class="reference internal" href="node-agent.html"><span class="doc">agent</span></a>. That is, once the active policy is recorded in the cache, any
configuration received through the agent that requests a different policy
will be rejected. This limitation will be removed in a future version of
CRI Resource Manager.</p>
<p>However, by default CRI Resource Manager will allow changing policies during
its startup phase. If you want to disable this you can pass the command line
option <code class="docutils literal notranslate"><span class="pre">--disable-policy-switch</span></code> to CRI Resource Manager.</p>
<p>If you run CRI Resource Manager with disabled policy switching, you can still
switch policies by clearing any policy-specific data stored in the cache while
CRI Resource Manager is shut down. You can do this by using the command line
option <code class="docutils literal notranslate"><span class="pre">--reset-policy</span></code>. The whole sequence of switching policies this way is</p>
<ul class="simple">
<li><p>stop cri-resmgr (<code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">stop</span> <span class="pre">cri-resource-manager</span></code>)</p></li>
<li><p>reset policy data (<code class="docutils literal notranslate"><span class="pre">cri-resmgr</span> <span class="pre">--reset-policy</span></code>)</p></li>
<li><p>change policy (<code class="docutils literal notranslate"><span class="pre">$EDITOR</span> <span class="pre">/etc/cri-resource-manager/fallback.cfg</span></code>)</p></li>
<li><p>start cri-resmgr (<code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">cri-resource-manager</span></code>)</p></li>
</ul>
</div>
<div class="section" id="container-adjustments">
<h3>Container Adjustments<a class="headerlink" href="#container-adjustments" title="Permalink to this headline">¶</a></h3>
<p>When the <a class="reference internal" href="node-agent.html"><span class="doc">agent</span></a> is in use, it is also possible to <code class="docutils literal notranslate"><span class="pre">adjust</span></code> container <code class="docutils literal notranslate"><span class="pre">resource</span> <span class="pre">assignments</span></code> externally, using dedicated <code class="docutils literal notranslate"><span class="pre">Adjustment</span></code> <code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">Resources</span></code> in
the <code class="docutils literal notranslate"><span class="pre">adjustments.criresmgr.intel.com</span></code> group. You can use the
<a class="reference external" href="https://github.com/intel/cri-resource-manager/blob/921c790d6fdac82adbcb5db1046fc8d05ccaad0b/pkg/apis/resmgr/v1alpha1/adjustment-schema.yaml">provided schema</a> to define
the <code class="docutils literal notranslate"><span class="pre">Adjustment</span></code> resource. Then you can copy and modify the
<a class="reference external" href="https://github.com/intel/cri-resource-manager/blob/921c790d6fdac82adbcb5db1046fc8d05ccaad0b/sample-configs/external-adjustment.yaml">sample adjustment CR</a> as a starting
point to test some overrides.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">Adjustment</span></code> consists of a</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">scope</span></code>:</p>
<ul>
<li><p>the nodes and containers to which the adjustment applies to</p></li>
</ul>
</li>
<li><p>adjustment data:</p>
<ul>
<li><p>updated native/compute resources (<code class="docutils literal notranslate"><span class="pre">cpu</span></code>/<code class="docutils literal notranslate"><span class="pre">memory</span></code> <code class="docutils literal notranslate"><span class="pre">requests</span></code> and <code class="docutils literal notranslate"><span class="pre">limits</span></code>)</p></li>
<li><p>updated <code class="docutils literal notranslate"><span class="pre">RDT</span></code> and/or <code class="docutils literal notranslate"><span class="pre">Block</span> <span class="pre">I/O</span></code> class</p></li>
<li><p>updated top tier (practically now DRAM) memory limit</p></li>
</ul>
</li>
</ul>
<p>All adjustment data is optional. An adjustment can choose to set any or all of
them as necessary. The current handling of adjustment update updates the resource
assignments of containers, marks all existing containers as having pending changes
in all controller domains, then triggers a rebalancing in the active policy. This
will cause all containers to be updated.</p>
<p>The scope defines which containers on what nodes the adjustment applies to. Nodes
are currently matched/picked by name, but a trailing wildcard (<code class="docutils literal notranslate"><span class="pre">*</span></code>) is allowed and
matches all nodes with the given prefix in their names.</p>
<p>Containers are matched by expressions. These are exactly the same as the expressions
for defining <a class="reference internal" href="policy/container-affinity.html"><span class="doc">affinity scopes</span></a>. A single adjustment can
specify multipe node/container match pairs. An adjustment will apply to all containers
in its scope. If an adjustment/update results in conflicts for some container, that is
at least one container is in the scope of multiple adjustments, the adjustment is
rejected and the whole update ignored.</p>
<div class="section" id="commands-for-declaring-creating-deleting-and-examining-adjustments">
<h4>Commands for Declaring, Creating, Deleting, and Examining Adjustments<a class="headerlink" href="#commands-for-declaring-creating-deleting-and-examining-adjustments" title="Permalink to this headline">¶</a></h4>
<p>You can declare the custom resource for adjustments with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">pkg</span><span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">resmgr</span><span class="o">/</span><span class="n">v1alpha1</span><span class="o">/</span><span class="n">adjustment</span><span class="o">-</span><span class="n">schema</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>You can then add adjustments with a command like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">sample</span><span class="o">-</span><span class="n">configs</span><span class="o">/</span><span class="n">external</span><span class="o">-</span><span class="n">adjustment</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>You can list existing adjustments with the following command. Use the right
<code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">namespace</span></code> option according to the namespace you use for the agent, for
the configuration and in your adjustment specifications.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>You can examine the contents of a single adjustments with these commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">adjustments</span> <span class="n">external</span><span class="o">-</span><span class="n">adjustment</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span><span class="o">/&lt;</span><span class="n">adjustment</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="o">-</span><span class="n">oyaml</span>
</pre></div>
</div>
<p>Or you can examine the contents of all adjustments like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="o">-</span><span class="n">oyaml</span>
</pre></div>
</div>
<p>Finally, you can delete and adjustment with commands like these:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="o">-</span><span class="n">f</span> <span class="n">sample</span><span class="o">-</span><span class="n">configs</span><span class="o">/</span><span class="n">external</span><span class="o">-</span><span class="n">adjustment</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span><span class="o">/&lt;</span><span class="n">adjustment</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>The status of adjustment updates is propagated back to the <code class="docutils literal notranslate"><span class="pre">Adjustment</span></code> <code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">Resources</span></code>,
more specifically into their <code class="docutils literal notranslate"><span class="pre">Status</span></code> fields. With the help of <code class="docutils literal notranslate"><span class="pre">jq</span></code>, you can easily
examine the status of external adjustments using a command like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kli</span><span class="nd">@r640</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">~&gt;</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">ojson</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">&#39;.items[].status&#39;</span>
<span class="p">{</span>
  <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;r640-1&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;r640-1&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above response is what you get for adjustments that applied without conflicts or
errors. You can see here that only node <em>r640-1</em> is in the scope of both of your
existing adjustments and those applied without errors.</p>
<p>If your adjustments resulted in errors, the output will look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klitkey1</span><span class="nd">@r640</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">~&gt;</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">criresmgr</span><span class="o">.</span><span class="n">intel</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">ojson</span> <span class="o">|</span> <span class="n">jq</span> <span class="s1">&#39;.items[].status&#39;</span>
<span class="p">{</span>
  <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;r640-1&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;b71a93523e58cb4ba0310aa225b2e2a329cef895ca4b96fcd9d12b375337ea35&quot;</span><span class="p">:</span> <span class="s2">&quot;cache: conflicting adjustments for my-pod-r640-1:my-container: adjustment-1,adjustment-2&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;r640-1&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;b71a93523e58cb4ba0310aa225b2e2a329cef895ca4b96fcd9d12b375337ea35&quot;</span><span class="p">:</span> <span class="s2">&quot;cache: conflicting adjustments for my-pod-r640-1:my-container: adjustment-1,adjustment-2&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Above you can see that on node <em>r640-1</em> the container with <code class="docutils literal notranslate"><span class="pre">ID</span></code>
<em>b71a93523e58cb4ba0310aa225b2e2a329cef895ca4b96fcd9d12b375337ea35</em>, or <em>my-container</em> of
<em>my-pod-r640-1</em>, had a conflict. Moreover you can see that the reason of the conflict is
that the container is in the scope of both <em>adjustment-1</em> and <em>adjustment-2</em>.</p>
<p>You can now fix those adjustments to resolve/remove the conflict then reapply the
adjustments, and then verify that the conflicts are gone.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kli@r640-1:~&gt; $EDITOR adjustment-1.yaml adjustment-2.yaml
kli@r640-1:~&gt; kubectl apply -f adjustment-1.yaml &amp;&amp; kubectl apply -f adjustment-1.yaml &amp;&amp; sleep 2
kli@r640-1:~&gt; kubectl get -n kube-system adjustments.criresmgr.intel.com -ojson | jq &#39;.items[].status&#39;
{
  &quot;nodes&quot;: {
    &quot;r640-1&quot;: {
      &quot;errors&quot;: {}
    }
  }
}
{
  &quot;nodes&quot;: {
    &quot;r640-1&quot;: {
      &quot;errors&quot;: {}
    }
  }
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-cri-resource-manager-as-a-message-dumper">
<h2>Using CRI Resource Manager as a Message Dumper<a class="headerlink" href="#using-cri-resource-manager-as-a-message-dumper" title="Permalink to this headline">¶</a></h2>
<p>You can use CRI Resource Manager to simply inspect all proxied CRI requests and
responses without applying any policy. Run CRI Resource Manager with the
provided <a class="reference external" href="https://github.com/intel/cri-resource-manager/blob/921c790d6fdac82adbcb5db1046fc8d05ccaad0b/sample-configs/cri-full-message-dump.cfg">sample configuration</a>
for doing this.</p>
</div>
<div class="section" id="using-docker-as-the-runtime">
<h2>Using Docker as the Runtime<a class="headerlink" href="#using-docker-as-the-runtime" title="Permalink to this headline">¶</a></h2>
<p>If you must use <code class="docutils literal notranslate"><span class="pre">docker</span></code> as the runtime then the proxying setup is slightly more
complex. Docker does not natively support the CRI API. Normally kubelet runs an
internal protocol translator, <code class="docutils literal notranslate"><span class="pre">dockershim</span></code> to translate between CRI and the
native docker API. To let CRI Resource Manager effectively proxy between kubelet
and <code class="docutils literal notranslate"><span class="pre">docker</span></code> it needs to actually proxy between kubelet and <code class="docutils literal notranslate"><span class="pre">dockershim</span></code>. For this to
be possible, you need to run two instances of kubelet:</p>
<ol class="simple">
<li><p>real instance talking to CRI Resource Manager/CRI</p></li>
<li><p>dockershim instance, acting as a CRI-docker protocol translator</p></li>
</ol>
<p>The real kubelet instance you run as you would normally with any other real CRI
runtime, but you specify the dockershim socket for the CRI Image Service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">kubelet</span> <span class="o">&lt;</span><span class="n">other</span><span class="o">-</span><span class="n">kubelet</span><span class="o">-</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="n">remote</span> \
     <span class="o">--</span><span class="n">container</span><span class="o">-</span><span class="n">runtime</span><span class="o">-</span><span class="n">endpoint</span><span class="o">=</span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">/</span><span class="n">cri</span><span class="o">-</span><span class="n">resmgr</span><span class="o">.</span><span class="n">sock</span> \
     <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">endpoint</span><span class="o">=</span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">dockershim</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
<p>The dockershim instance you run like this, picking the cgroupfs driver according
to your real kubelet instance’s configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">kubelet</span> <span class="o">--</span><span class="n">experimental</span><span class="o">-</span><span class="n">dockershim</span> <span class="o">--</span><span class="n">port</span> <span class="mi">11250</span> <span class="o">--</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span> <span class="p">{</span><span class="n">systemd</span><span class="o">|</span><span class="n">cgroupfs</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-and-debugging">
<h2>Logging and Debugging<a class="headerlink" href="#logging-and-debugging" title="Permalink to this headline">¶</a></h2>
<p>You can control logging and debugging with the <code class="docutils literal notranslate"><span class="pre">--logger-*</span></code> command line options. By
default debug logs are globally disabled. You can turn on full debug logs with the
<code class="docutils literal notranslate"><span class="pre">--logger-debug</span> <span class="pre">'*'</span></code> command line option.</p>
<!-- Links --></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="policy/index.html" class="btn btn-neutral float-right" title="Policies" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, various

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
  
    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
      <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> GitHub Pages</span>
        v: devel
        <span class="fa fa-caret-down"></span>
      </span>
      <div class="rst-other-versions">
        <dl id="versions">
          <dt>Versions</dt>
          <dt>
        </dl>
        <dl>
          <a href="/cri-resource-manager/releases">all releases</a>
          </dt>
        </dl>
      </div>
    </div>
  
  <script src="../../versions.js"></script>
  <script>
      var list = document.getElementById('versions')
      var menuItems = getVersionsMenuItems();
      for (var i=0; i < menuItems.length; i++) {
        var item = document.createElement('dd');
        var anchor = item.appendChild(document.createElement('a'));
        anchor.appendChild(document.createTextNode(menuItems[i].name));
        anchor.href = menuItems[i].url;
        list.appendChild(item);
      }
  </script>


</body>
</html>