# CRI-Resource-Manager extension for Gardener

**Note:** This is work in progress, not meant to run in production!

### Introduction

Those charts will deploy CRI-resource-manager as proxy between kubectl and containerd for "shoot" clusters deployed by Gardener.

### Description

There are two charts:

- charts/**gardener-extension-cri-rm** - used to deploy extension (by deploying "extension" image) in **Seed** cluster - it is not deployed manually but using `ControllerRegistration` and `ControllerDeployment` manifest in `examples/ctrldeploy-ctrlreg.yaml` which are generated by script `hacks/generate-controller-registration.sh`,
- charts/**cri-rm-installation** - internal chart that is included inside "installation" image and used to install `cri-resource-manager` binary inside worker nodes in **Shoot** clusters - it is not meant to be run manually but rather deployed by **gardener-extension-cri-rm** chart

### Prerequisites

- working dir for `mkdir ~/work`
- *kubectl* 1.20+
- *cri-resource-manager* is cloned to ~/work path (temporary ppalucki fork with "gardener" branch) like this:
    ```
    git clone https://github.com/ppalucki/cri-resource-manager/ ~/work/cri-resource-manager
    ```

## I. Getting started locally (with kind-based local gardener setup).

### Prepare local kind-based garden cluster

#### 1. Clone the gardener
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
```

#### 2. Prepare kind cluster 

This is based on https://github.com/gardener/gardener/blob/master/docs/deployment/getting_started_locally.md


```
cd ~/work/gardener
make kind-up

kubectl cluster-info --context kind-gardener-local --kubeconfig /root/work/gardener/example/gardener-local/kind/kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/work/gardener/example/provider-local/base/kubeconfig
# WARNING!: this overwrites your local kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/.kube/config
```

Check everything is fine:
```
kubectl get nodes
```

####  3. Deploy local gardener

```
make gardener-up
```

Check that three gardener charts are installed:
```
helm list -n garden
```

### Deploy cri-rm extension

#### 4. (Optional) Regenerate ctrldeploy-ctrlreg.yaml file:

```
cd ~/work/cri-resource-manager/packaging/gardener/
./hacks/generate-controller-registation.sh
```

#### 5. Deploy cri-rm-extension as Gardener extension using ControllerRegistration/ControllerDeployment

```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/ctrldeploy-ctrlreg.yaml
```

Checkout installed objects:
```
kubectl get controllerregistrations.core.gardener.cloud cri-rm-extension
kubectl get controllerdeployments.core.gardener.cloud cri-rm-extension
```
There should be 'cri-rm-extension   Extension/cri-rm-extension' resources visible alongside cri-rm-extension deployment.

but installation should not be yet available - there is not yet shoot cluster available.

```
kubectl get controllerinstallation.core.gardener.cloud 
```

#### 5. Deploy shoot "local" cluster.

Build an image with extension and upload to local kind cluster
```
make docker-images
kind load docker-image gardener-extension-cri-rm:latest --name gardener-local
kind load gardener-extension-cri-rm-installation:latest --name gardener-local
```


```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/shoot.yaml
```

Check that shoot cluster is ready:

```
kubectl get shoots.core.gardener.cloud -n garden-local --watch -o wide
```

#### 6. Verify that ManagedResources are properly installed in shoot 'garden' (seed class) and  'shoot--local--local' namespace

```
kubectl get managedresource -n garden | grep cri-rm-extension
kubectl get managedresource -n shoot--local--local | grep cri-rm-installation
```

#### 7. Check shoot cluster node is ready

First get credentials to access shoot cluster:

``` 
kubectl -n garden-local get secret local.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d > /tmp/kubeconfig-shoot-local.yaml
```

and check status of the node:
```
kubectl --kubeconfig=/tmp/kubeconfig-shoot-local.yaml get nodes
```

#### 8. Check CRI-resource-manager is installed properly as proxy

```
kubectl exec -n shoot--local--local `kubectl get pod -n shoot--local--local --no-headers G machine-shoot | awk '{print $1}'` -- systemctl status cri-resource-manager kubelet -n 0
```
