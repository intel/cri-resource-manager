# CRI-Resource-Manager extension for Gardener

## Introduction

This charts will deploy CRI-resource-manager as proxy between kubectl and containerd for "shoot" clusters deployed by Gardener.

## Description

There are two charts:

- *cri-rm-extension* - generated by generate-controller-registration.sh script from gardener project to install extension to garden cluster using ControllerRegistration (CR) and ControllerDeployment (CD)
- *cri-rm-installation* - internal chart that is included inside ControllerDeployment used to install cri-resource-manager binary inside worker nodes in Shoort clusters - it is not meant to be run manually but rather deployed by *cri-rm-extension* chart

To install extension you just need to use *cri-rm-extension* chart.


### Prerequsities

- kubectl 1.20+
- helm 3.7+
- cri-resource-manager is cloned to ~/work path (temporary ppalucki fork with "gardener" branch) like this:
    ```
    git clone https://github.com/ppalucki/cri-resource-manager/ ~/work/cri-resource-manager
    ```
- (optionally) Use kubectl plugins for context and config management:

    Krew: https://krew.sigs.k8s.io/docs/user-guide/setup/install/

    then this plugins:

    ```
    kubectl krew install ctx
    kubectl krew install config
    kubectl krew install view-secret
    kubectl krew install trace
    ```

### I. (Optional) Generate extension chart based on cri-rm-installation chart.

Current release is already generated in cri-rm-extension/templates/

This is optionall step ff you change the cri-rm-installation chart you need to update providerConfig.config in cri-rm-extension chart with following steps:

1. Clone gardner project to get access to generate ControllerDeployment/ControllerRegistration resources:
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
```

2. (optionally) Fix unsupported tar (for old tar version) arguments issue (remote sort/user/group arguments from the script):

```
sed -i 's/--sort=name//' ~/work/gardener/hack/generate-controller-registration.sh
sed -i 's/--owner=root:0//' ~/work/gardener/hack/generate-controller-registration.sh
sed -i 's/--group=root:0//' ~/work/gardener/hack/generate-controller-registration.sh
```

3. Generate CR/CD yamls from charts directory:

```
cd ~/work/cri-resource-manager/packaging/gardener/charts
~/work/gardener/hack/generate-controller-registration.sh --optional cri-rm-extension cri-rm-installation v0.0.1 cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml Extension:cri-rm-extension
```

4. Patch generated yamls to include additionall value "shoot_namespace"

```
# Add value at 12 line:
sed -i '12i\ \ \ \ shoot_namespace: {{ .Values.shoot_namespace }}' ~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml
```


## II. Getting started locally (with kind-based local gardener setup).


### Prepare local kind-based garden cluster


#### 1. Clone the gardener
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
cd ~/work/gardener
```

#### 2. Preapre kind cluster 

This is based on https://github.com/gardener/gardener/blob/master/docs/deployment/getting_started_locally.md


```
make kind-up

kubectl cluster-info --context kind-gardener-local --kubeconfig /root/work/gardener/example/gardener-local/kind/kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/work/gardener/example/provider-local/base/kubeconfig
# WARNING!: this overwrites your local kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/.kube/config
```

Check everything is fine:
```
kubectl get nodes
docker ps
kubectl ctx
```
We should use kind-gardener-local context to connect to this setup.

####  3. Deploy local gardener

```
make gardener-up
```

Check that three gardener charts are installed:
```
helm list -n garden
```



#### 4. Deploy cri-rm-extension as Gardener extension using ControllerRegistration/ControllerDeployment

```
helm install cri-rm-extension ~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension
```

Checkout helm charts:

```
helm list -n default
helm get all cri-rm-extension
```

Checkout installed objects:
```
kubectl get controllerregistrations.core.gardener.cloud
kubectl get controllerdeployments.core.gardener.cloud
```
There should be 'cri-rm-extension   Extension/cri-rm-extension' resources visiable alongside cri-rm-extension deployment.

but installion should not be ready yet - there is not yet shoot cluster available.

```
kubectl get controllerinstallation.core.gardener.cloud
```

#### 5. Deploy shoot "local" cluster.

```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/shoot.yaml
```

Check that shoot cluster is ready:

```
kubectl get shoots.core.gardener.cloud -n garden-local --watch -o wide
```

