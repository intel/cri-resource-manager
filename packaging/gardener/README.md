# CRI-Resource-Manager extension for Gardener


**OUTDATED: we're in progress to use full fledged operator approach**

Note: This is work in progress and so far the only installed resources in shoot cluster are two configmaps for testing - in future they will be replaced with "installation" DaemonSet that will copy necessary binary and reconfigure and restart kubelet.

### Introduction

This charts will deploy CRI-resource-manager as proxy between kubectl and containerd for "shoot" clusters deployed by Gardener.


### Description

There are two charts:

- charts/**cri-rm-extension** - generated by generate-controller-registration.sh script from gardener project to install extension to garden cluster using ControllerRegistration (CR) and ControllerDeployment (CD)
- charts/**cri-rm-installation** - internal chart that is included inside ControllerDeployment used to install cri-resource-manager binary inside worker nodes in Shoot clusters - it is not meant to be run manually but rather deployed by *cri-rm-extension* chart

To install extension you just need to use *cri-rm-extension* chart.


### Prerequisites

- working dir for `mkdir ~/work`
- *kubectl* 1.20+
- *helm* 3.7+
- *cri-resource-manager* is cloned to ~/work path (temporary ppalucki fork with "gardener" branch) like this:
    ```
    git clone https://github.com/ppalucki/cri-resource-manager/ ~/work/cri-resource-manager
    ```

## I. Getting started locally (with kind-based local gardener setup).

### Prepare local kind-based garden cluster

#### 1. Clone the gardener
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
```

#### 2. Prepare kind cluster 

This is based on https://github.com/gardener/gardener/blob/master/docs/deployment/getting_started_locally.md


```
cd ~/work/gardener
make kind-up

kubectl cluster-info --context kind-gardener-local --kubeconfig /root/work/gardener/example/gardener-local/kind/kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/work/gardener/example/provider-local/base/kubeconfig
# WARNING!: this overwrites your local kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/.kube/config
```

Check everything is fine:
```
kubectl get nodes
```

####  3. Deploy local gardener

```
make gardener-up
```

Check that three gardener charts are installed:
```
helm list -n garden
```

### Deploy cri-rm extenion

#### 4. Deploy cri-rm-extension as Gardener extension using ControllerRegistration/ControllerDeployment

To install extension to specific shoot cluster - you need to specify its namespace in chart values name: eg.

values.yaml:
```
shoot_namespace: shoot--local--local
```

and then:

```
helm install cri-rm-extension ~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension
```

Checkout helm charts:

```
helm list -n default
helm get all cri-rm-extension
```

Checkout installed objects:
```
kubectl get controllerregistrations.core.gardener.cloud
kubectl get controllerdeployments.core.gardener.cloud
```
There should be 'cri-rm-extension   Extension/cri-rm-extension' resources visible alongside cri-rm-extension deployment.

but installation should not be yet available - there is not yet shoot cluster available.

```
kubectl get controllerinstallation.core.gardener.cloud
```

#### 5. Deploy shoot "local" cluster.

```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/shoot.yaml
```

Check that shoot cluster is ready:

```
kubectl get shoots.core.gardener.cloud -n garden-local --watch -o wide
```

#### 6. Verify that ManagedResources are properly installed in shoot 'garden' (seed class) and  'shoot--local--local' namespace



```
kubectl get managedresource -n garden | grep cri-rm-extension
kubectl get managedresource -n shoot--local--local | grep cri-rm-installation
```



#### 7. Install Extension object manually into seed cluster.

```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/extension.yaml
```

First get credentials to access shoot cluster:

``` 
kubectl -n garden-local get secret local.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d > /tmp/kubeconfig-shoot-local.yaml
# Check you can connect to node
kubectl --kubeconfig=/tmp/kubeconfig-shoot-local.yaml get nodes
```

Then check managed resources were created:


```
kubectl get managedresource -n garden | grep cri-rm-extension
kubectl get managedresource -n shoot--local--local cri-rm-installation -o yaml
```


Check that the resources from cri-rm-installation were deployed to shoot cluster.
```
kubectl --kubeconfig=/tmp/kubeconfig-shoot-local.yaml get cm -n default | grep cri-rm-installation-example
```

#### 8. Optional extenion installation 

Enable required extension in shoot.yaml definition and then following objects should be created automatically:

```
kubectl apply -f ~/work/cri-resource-manager/packaging/gardener/examples/extension.yaml

```


## II. Generating extension chart based on cri-rm-installation chart.

This step is optional. Current release is already generated in cri-rm-extension/templates/

This is optional step ff you change the cri-rm-installation chart you need to update providerConfig.config in cri-rm-extension chart with following steps:

#### 1. Clone Gardener project to get access to generate ControllerDeployment/ControllerRegistration resources:
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
```

#### 2. (optionally) Fix unsupported tar (for old tar version) arguments issue (remote sort/user/group arguments from the script):

```
sed -i 's/--sort=name//' ~/work/gardener/hack/generate-controller-registration.sh
sed -i 's/--owner=root:0//' ~/work/gardener/hack/generate-controller-registration.sh
sed -i 's/--group=root:0//' ~/work/gardener/hack/generate-controller-registration.sh
```

#### 3. Generate CR/CD yamls from charts directory:

```
cd ~/work/cri-resource-manager/packaging/gardener/charts
~/work/gardener/hack/generate-controller-registration.sh cri-rm-extension cri-rm-installation v0.0.1 cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml Extension:cri-rm-extension
```



#### 4. Patch generated yamls to include additional value "shoot_namespace"

```
# Add value at 12 line:
sed -i '12i\ \ \ \ shoot_namespace: {{ .Values.shoot_namespace }}' ~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml


# Make it globallyEnabled
echo '    globallyEnabled: true' >>~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml
```

Take a look on generated file:
```
cat ~/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension/templates/ctrldeploy-ctrlreg.yaml
```

### 1.  Alternative approach for develpoment purposes.

```
cd /root/work/cri-resource-manager/packaging/gardener/charts
chart="$(tar -c cri-rm-installation | gzip -n | base64 | tr -d '\n')"
echo $chart
cd /root/work/cri-resource-manager/packaging/gardener/charts/cri-rm-extension
helm template --set chart=$chart cri-rm-extension
helm install --set chart=$chart cri-rm-extension cri-rm-extension

helm uninstall cri-rm-extension
```
